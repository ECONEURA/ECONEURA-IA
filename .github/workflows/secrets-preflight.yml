name: Secrets Preflight Check

on:
  push:
    branches: [ main, develop, 'pr/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: {}

env:
  DEPLOY_ENABLED: false

permissions:
  contents: read

jobs:
  secrets-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ env.DEPLOY_ENABLED }}" = "true" ]; then
            echo "🔍 Verificando secrets requeridos para deployment..."
          else
            echo "ℹ️ DEPLOY_ENABLED=false - skipping secrets check"
            echo "✅ Secrets check bypassed for CI-only branch"
            exit 0
          fi
          
      - name: Verify required secrets (only if deployment enabled)
        if: env.DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          missing=()
          if [ -z "${{ secrets.PLAYWRIGHT_BASE_URL }}" ]; then
            echo "Missing PLAYWRIGHT_BASE_URL"; missing+=(PLAYWRIGHT_BASE_URL); fi
          if [ -z "${{ secrets.K6_BASE_URL }}" ]; then
            echo "Missing K6_BASE_URL"; missing+=(K6_BASE_URL); fi
          if [ ${#missing[@]} -gt 0 ]; then
            echo "HIL_REQUIRED: add repository secrets -> ${missing[*]}" >&2
            exit 1
          fi
          echo "✅ All required secrets are available"